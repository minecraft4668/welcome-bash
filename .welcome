#!/bin/bash
# 自定义显示顺序及内容请见文件末尾
# 代码说明：
# linedown [LINE_TIMES=1] 输出指定行数 (默认1行)
# output_os 输出操作系统信息
# hitokoto 输出一言
# color_test 颜色测试

CURL_TIMEOUT=3             # curl超时时间（秒）

# 背景色

BG_BLACK="\e[40m"   # 黑色
BG_RED="\e[41m"     # 红色
BG_GREEN="\e[42m"   # 绿色
BG_YELLOW="\e[43m"  # 黄色
BG_BLUE="\e[44m"    # 蓝色
BG_MAGENTA="\e[45m" # 紫色
BG_CYAN="\e[46m"    # 青色
BG_WHITE="\e[47m"   # 白色

BG_BRIGHT_BLACK="\e[100m"   # 稍亮的黑色
BG_BRIGHT_RED="\e[101m"     # 亮红色
BG_BRIGHT_GREEN="\e[102m"   # 浅绿色
BG_BRIGHT_YELLOW="\e[103m"  # 亮黄色
BG_BRIGHT_BLUE="\e[104m"    # 亮蓝色
BG_BRIGHT_MAGENTA="\e[105m" # 亮紫色
BG_BRIGHT_CYAN="\e[106m"    # 亮青色
BG_BRIGHT_WHITE="\e[107m"   # 亮白色

# 前景色（文本色）
TEXT_BLACK="\x1B[30;1m"  # 黑色
TEXT_WHITE="\x1B[37;1m"  # 白色
TEXT_YELLOW="\x1B[33;1m" # 黄色
TEXT_GREEN="\x1B[32;1m"  # 绿色
TEXT_CYAN="\x1B[36;1m"   # 青色
TEXT_RED="\x1B[31;1m"    # 红色
TEXT_BLUE="\x1B[34;1m"   # 蓝色
TEXT_MAGENTA="\x1B[35;1m" # 紫色

# 字体样式
TEXT_UL="\x1B[4m"     # 下划线
TEXT_BOLD="\x1B[1m"   # 加粗
TEXT_BLINK="\x1B[5m"  # 闪烁
TEXT_INVERT="\x1B[7m" # 反转
TEXT_DISAPP="\x1B[8m" # 消失

# 清空当前层效果

NC="\x1B[0m"

linedown() {
    local LINE_TIMES=${1:-1}
    for i in {1..$LINE_TIMES}; do
        echo ""
    done
}

output_os() {
    echo -e "${BG_BLUE}$(uname -s -r -o) running on\c" # running on ${OS_VERSION}${NC}"
    case "$(uname -s)" in
        Linux*)
            if [ -f /etc/os-release ]; then
                . /etc/os-release
                echo "${BG_WHITE}${TEXT_MAGENTA}Linux ($PRETTY_NAME)"
            elif [ -f /etc/lsb-release ]; then
                . /etc/lsb-release
                echo "${BG_WHITE}${TEXT_MAGENTA}Linux ($DISTRIB_DESCRIPTION)"
            else
                echo "${BG_WHITE}${TEXT_MAGENTA}Linux (Unknown distribution)"
            fi
            
            # 检测 WSL
            if uname -r | grep -q microsoft; then
                echo "${NC}  ${BG_MAGENTA}${TEXT_CYAN}Running on Windows Subsystem for Linux ↲${NC}${NC}"
            fi
            ;;
            
        Darwin*)
            echo "${BG_WHITE}${TEXT_MAGENTA}macOS $(sw_vers -productVersion)"
            ;;
            
        CYGWIN*)
            echo "${BG_WHITE}${TEXT_MAGENTA}Windows (Cygwin $(uname -r))"
            is_win=1
            ;;

        MINGW*)
            echo "${BG_WHITE}${TEXT_MAGENTA}Windows (MINGW $(gcc -v)))"
            is_win=1
            ;;

        MSYS*)
            echo "${BG_WHITE}${TEXT_MAGENTA}Windows (MSYS $(pacman -Q msys2-runtime))"
            is_win=1
            ;;
            
        *)
            echo "${BG_WHITE}${TEXT_MAGENTA}Unknown Operating System"
            ;;
    esac
}

welcome_words() {
    echo -e "${TEXT_CYAN}Edited by Core.io${NC}"
    echo -e "${BG_BRIGHT_GREEN} Welcome Bash v1.1${NC}"
}

output_hosts() {
    if [[ -f /etc/hostname && ! -s "/etc/hostname" ]]; then
        echo -e "${BG_BLUE}$(whoami)@$(cat /etc/hostname) log in at $(date)${NC}"
    else
        echo -e "${BG_BLUE}$(whoami)@$(uname -n) log in at $(date)${NC}"
    fi
}

hitokoto() {
    hitokoto=$(curl -s --connect-timeout $CURL_TIMEOUT 'https://v1.hitokoto.cn/?c=f&encode=text')
    if [ -n "$hitokoto" ]; then
        echo -e "${BG_GREEN}每日一言：${hitokoto}${NC}"
    else
        echo -e "${BG_RED}API调用失败，尝试使用本地库......${NC}"
        file_to_source=~/.hitokoto_lib
        if [ ! -f "$file_to_source" ]; then
            echo -e "${TEXT_RED}错误: 文件 $file_to_source 不存在${NC}" >&2
        elif source "$file_to_source" 2>/dev/null; then
            if declare -F get_random_hitokoto > /dev/null; then
                echo -e "${BG_GREEN}${TEXT_INVERT}每日一言：$(get_random_hitokoto)${NC}"
            else
                echo -e "${TEXT_RED}错误:库文件不完整！${NC}" >&2
            fi
        else
            echo -e "${TEXT_RED}错误: 无法加载文件 $file_to_source${NC}" >&2
        fi
    fi
}

# 颜色测试
color_test() {
    for i in {0..15}; do
        printf "\x1B[48;5;${i}m%4s\x1B[0m" ""
        [ $((($i + 1) % 8)) -eq 0 ] && echo
    done
}

# === 顺序排列及自定义 ===
output_os
linedown
welcome_words
linedown
output_hosts
hitokoto